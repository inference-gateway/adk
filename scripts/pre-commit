#!/bin/bash

set -e

echo "ğŸ” Running pre-commit checks..."

go_files=$(git diff --cached --name-only | grep '\.go$' || true)
md_files=$(git diff --cached --name-only | grep '\.md$' || true)

if [ -n "$go_files" ]; then
    echo "ğŸ“ Go files detected - running full checks..."
    
    echo "  ğŸ¨ Formatting code..."
    task format
    
    echo "  ğŸ§¹ Tidying Go modules..."
    task tidy
    
    echo "  ğŸ” Running linter..."
    task lint
    
    echo "  ğŸ§ª Running tests..."
    task test
    
    echo "$go_files" | xargs git add
fi

if [ -n "$md_files" ]; then
    if [ -z "$go_files" ]; then
        echo "ğŸ“ Only Markdown files detected - running formatting..."
        task format
    fi
    
    echo "$md_files" | xargs git add
fi


if [ -z "$go_files" ] && [ -z "$md_files" ]; then
    echo "â„¹ï¸  No Go or Markdown files to check"
fi

echo "âœ… All pre-commit checks passed!"
